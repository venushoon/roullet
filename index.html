<!DOCTYPE html>
<html lang="ko" data-theme="dark">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ë£°ë › í”„ë¡œê·¸ë¨ | Roullet</title>
<style>
  :root{
    --bg-1:#0f1220; --bg-2:#171a2b; --panel:#1b2142cc;
    --text:#e9ecf1; --muted:#9aa3b2;
    --primary:#5865F2; --primary-2:#7c8bff;
    --ring:0 0 0 3px rgba(88,101,242,.28);
    --shadow:0 10px 30px rgba(0,0,0,.35);
    --radius:16px;
    --input-bg:#0f1433; --input-br:#2f3566;
    --btn1:#2a33a8; --btn2:#1b2088; --btn-br:#4b57ff66;
    --ghost-bg:#0e1435; --ghost-br:#2d3470; --ghost-tx:#d7dcff;
    --panel-line:#2a2f55; --section-bg:#12173180;
  }
  html[data-theme="light"]{
    --bg-1:#f6f7fb; --bg-2:#eef1fb; --panel:#ffffffee;
    --text:#101322; --muted:#4b5570;
    --primary:#3743d9; --primary-2:#4d5cff;
    --ring:0 0 0 3px rgba(77,92,255,.25);
    --shadow:0 10px 30px rgba(10,14,40,.12);
    --input-bg:#ffffff; --input-br:#c9cfef;
    --btn1:#4d5cff; --btn2:#3743d9; --btn-br:#4b57ff66;
    --ghost-bg:#f3f5ff; --ghost-br:#c9d1ff; --ghost-tx:#1a237e;
    --panel-line:#e2e7ff; --section-bg:#f7f8ff;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--text);
    font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR","Apple SD Gothic Neo","Malgun Gothic",sans-serif;
    background:
      radial-gradient(1200px 600px at 20% 0%, #1f294e33, transparent 60%),
      radial-gradient(800px 600px at 100% 100%, #2a3a8a30, transparent 60%),
      linear-gradient(180deg,var(--bg-1),var(--bg-2));
  }
  .wrap{display:grid;grid-template-columns:minmax(360px,1fr) 440px;gap:20px;height:100%;padding:20px}
  .panel{background:var(--panel);backdrop-filter:blur(8px);border:1px solid var(--panel-line);border-radius:var(--radius);box-shadow:var(--shadow)}
  .left{position:relative;display:grid;grid-template-rows:auto 1fr;align-items:center;justify-items:center;padding:24px}
  .title{width:100%;display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
  .title h1{font-size:18px;font-weight:800;margin:0;letter-spacing:.2px;opacity:.9}
  /* â–¼ í¬ì¸í„°(ì—­ì‚¼ê°í˜•) */
  .pointer{position:absolute;top:68px;left:50%;transform:translateX(-50%);width:0;height:0;border-left:18px solid transparent;border-right:18px solid transparent;border-top:28px solid #ff5a5a;filter:drop-shadow(0 10px 14px rgba(0,0,0,.45))}
  .canvas-box{position:relative;width:min(90vmin, 920px);aspect-ratio:1/1;display:grid;place-items:center}
  canvas{width:100%;height:100%}
  /* ì¤‘ì•™ ì‹œì‘ ë²„íŠ¼ */
  .center-start{
    position:absolute; inset:auto; width:160px; height:160px; border-radius:50%;
    display:grid; place-items:center; font-weight:900; font-size:22px; color:#fff;
    background: radial-gradient(circle at 35% 30%, #ffa142, #ff7a1f 60%, #e4551a 100%);
    border:10px solid #fff; box-shadow:0 14px 24px rgba(0,0,0,.35); cursor:pointer; user-select:none;
  }
  .center-start:disabled{ filter:grayscale(.4) brightness(.9); cursor:not-allowed; }

  .right{display:flex;flex-direction:column;padding:18px;gap:14px}
  .section{padding:14px;border-radius:12px;background:var(--section-bg);border:1px solid var(--panel-line)}
  .section h2{font-size:14px;font-weight:800;letter-spacing:.4px;margin:0 0 10px 0;color:var(--primary-2);text-transform:uppercase}
  .input-row{display:flex;gap:10px;align-items:center}
  .input{flex:1;padding:12px 14px;border-radius:12px;border:1px solid var(--input-br);background:var(--input-bg);color:var(--text);outline:none;transition:box-shadow .15s,border-color .15s;font-size:15px}
  .input::placeholder{color:var(--muted)} .input:focus{box-shadow:var(--ring);border-color:var(--primary-2)}
  .btn{all:unset;display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 12px;border-radius:12px;cursor:pointer;color:#fff;font-weight:800;font-size:14px;background:linear-gradient(180deg,var(--btn1),var(--btn2));border:1px solid var(--btn-br);box-shadow:0 10px 20px rgba(37,48,140,.35);transition:transform .08s ease,filter .2s ease}
  .btn:active{transform:translateY(1px)} .btn:hover{filter:brightness(1.05)}
  .btn-ghost{background:var(--ghost-bg);border:1px solid var(--ghost-br);box-shadow:none;color:var(--ghost-tx)}
  .btn-ok{background:linear-gradient(180deg,#22c55e,#16a34a)}
  .btn-danger{background:linear-gradient(180deg,#ef4444,#dc2626)}
  .note{color:var(--muted);font-size:12px}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  table{width:100%;border-collapse:separate;border-spacing:0 8px}
  td{padding:6px 4px}
  td input[type="number"]{width:90px;padding:8px;border-radius:10px;border:1px solid var(--input-br);background:var(--input-bg);color:var(--text)}
  .result-toast{position:absolute;inset:auto 0 16px 0;display:grid;place-items:center;pointer-events:none}
  .result-badge{display:inline-block;padding:10px 14px;border-radius:999px;font-size:18px;font-weight:900;background:#11163aee;border:1px solid #33408a;box-shadow:var(--shadow)}
  #editor{display:none}
  .record{font-size:13px;color:var(--muted)}
  .record b{color:#fff}
  @media (max-width:980px){.wrap{grid-template-columns:1fr}.pointer{top:62px}}
</style>
</head>
<body>
  <div class="wrap">
    <!-- LEFT -->
    <div class="panel left">
      <div class="title">
        <h1>ğŸ¡ ë£°ë ›</h1>
        <div style="display:flex;gap:8px">
          <button class="btn btn-ghost" id="btnReset">â†º ì´ˆê¸°í™”</button>
          <button class="btn btn-ghost" id="btnBig">ğŸ–¥ ëŒ€í˜•</button>
        </div>
      </div>

      <div class="pointer" aria-hidden="true"></div>

      <div class="canvas-box">
        <canvas id="wheel" width="920" height="920"></canvas>
        <button id="btnCenterStart" class="center-start">ì‹œì‘í•˜ê¸°</button>
      </div>

      <div class="result-toast" aria-live="polite" aria-atomic="true">
        <div id="resultBadge" class="result-badge" style="display:none"></div>
      </div>
    </div>

    <!-- RIGHT -->
    <aside class="panel right">
      <!-- ì…ë ¥/ë¶ˆëŸ¬ì˜¤ê¸° -->
      <div class="section">
        <h2>ì…ë ¥ Â· ë¶ˆëŸ¬ì˜¤ê¸°</h2>
        <div class="input-row">
          <input id="itemInput" class="input" type="text" placeholder="í•œ ì¤„ì— 1ê°œ ì…ë ¥ í›„ Enter" />
          <button class="btn" id="btnAdd">+ ì¶”ê°€</button>
        </div>
        <div class="grid-2" style="margin-top:8px">
          <button class="btn btn-ghost" id="btnLoadFile">ğŸ“ íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸° (.txt/.csv)</button>
          <input id="fileInput" type="file" accept=".txt,.csv" style="display:none" />
          <button class="btn btn-ghost" id="btnDownloadSamples">â¬‡ ìƒ˜í”Œ ë‚´ë ¤ë°›ê¸°</button>
        </div>
        <div class="note" style="margin-top:6px">
          â€¢ TXT: ì¤„ë§ˆë‹¤ í•­ëª©<br/>
          â€¢ CSV: label,weight (weight ìƒëµ ê°€ëŠ¥)
        </div>
      </div>

      <!-- í•­ëª©/ë¹„ì¤‘ í¸ì§‘ -->
      <div class="section">
        <h2>í•­ëª© ë³´ê¸°/ìˆ¨ê¸°ê¸° & ë¹„ì¤‘ í¸ì§‘</h2>
        <div class="grid-2" style="margin-bottom:8px">
          <button class="btn" id="btnToggleEditor">ğŸ‘ í•­ëª© ë³´ê¸°/ìˆ¨ê¸°ê¸°</button>
          <button class="btn btn-ok" id="btnSave">ğŸ’¾ ì €ì¥í•˜ê¸°</button>
        </div>
        <div class="note">â€¢ ë¹„ì¤‘ ë¯¸ì…ë ¥ ì‹œ ë™ë“± ë°°ë¶„ Â· ì¼ë¶€ë§Œ ì…ë ¥ ì‹œ ë‚¨ì€ ë¹„ì¤‘ì„ ë¯¸ì…ë ¥ìì—ê²Œ ê· ë“± ë°°ë¶„(ì´ 100 ê¸°ì¤€)</div>
        <div id="editor">
          <table id="editTable"><tbody></tbody></table>
        </div>
      </div>

      <!-- ì˜µì…˜ -->
      <div class="section">
        <h2>ì˜µì…˜</h2>
        <label style="display:flex;align-items:center;gap:10px;margin-top:6px">
          <input id="chkDupe" type="checkbox" checked /> ë½‘ê¸° ì¤‘ë³µ í—ˆìš©(ì²´í¬ ì‹œ ë‹¹ì²¨ í›„ ì‚­ì œ ì•ˆ í•¨)
        </label>
        <label style="display:flex;align-items:center;gap:10px;margin-top:6px">
          <input id="chkTheme" type="checkbox" /> ë°ì€(í”„ë¡œì í„°) ëª¨ë“œ
        </label>
      </div>

      <!-- ê¸°ë¡ -->
      <div class="section">
        <h2>ì¶”ì²¨ ê¸°ë¡</h2>
        <div class="grid-2" style="margin-bottom:8px">
          <button class="btn btn-ghost" id="btnToggleLog">ğŸ“ ê¸°ë¡ ë³´ê¸°/ìˆ¨ê¸°ê¸°</button>
          <button class="btn btn-danger" id="btnClearLog">ğŸ—‘ ê¸°ë¡ ì‚­ì œ</button>
        </div>
        <div id="logBox" style="display:none;max-height:180px;overflow:auto" class="record"></div>
      </div>
    </aside>
  </div>

<script>
/* ================== State ================== */
let items = [];        // [{label, weight? number|null}]
let segments = [];     // [{label,start,end,center,weight}]
let allowDuplicate = true; // ê¸°ë³¸: ì‚­ì œ ì•ˆ í•¨
let angle = 0;         // current rotation (rad)
let spinning = false;
const TWO_PI = Math.PI * 2;
const POINTER_ANGLE = -Math.PI/2; // pointer is at 12 o'clock
const historyLog = [];

/* ================== DOM ================== */
const canvas = document.getElementById('wheel');
const ctx = canvas.getContext('2d');
const ipt = document.getElementById('itemInput');
const resultBadge = document.getElementById('resultBadge');
const btnCenterStart = document.getElementById('btnCenterStart');
const fileInput = document.getElementById('fileInput');
const editTableBody = document.querySelector('#editTable tbody');
const logBox = document.getElementById('logBox');

/* ================== Utils ================== */
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const norm=a=> (a%TWO_PI + TWO_PI)%TWO_PI;
function fmtTime(d){
  const pad=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}

/* ================== Build Segments (weights) ================== */
function rebuildSegments(){
  if(items.length===0){ segments=[]; drawWheel(); return; }

  // 1) gather weights (percentage-ish)
  const n = items.length;
  let sumSpecified = 0, specifiedCount = 0, unspecifiedIdx=[];
  const weights = new Array(n).fill(0);
  for(let i=0;i<n;i++){
    const w = Number(items[i].weight);
    if(!isNaN(w) && w>0){ weights[i]=w; sumSpecified+=w; specifiedCount++; }
    else { unspecifiedIdx.push(i); }
  }

  // 2) distribute
  if(specifiedCount===0){ // equal
    for(let i=0;i<n;i++) weights[i]=100/n;
  }else{
    const remaining = Math.max(0, 100 - sumSpecified);
    const share = unspecifiedIdx.length>0 ? remaining/unspecifiedIdx.length : 0;
    for(const i of unspecifiedIdx){ weights[i]=share>0?share:0; }
  }

  // 3) normalize to 1.0
  const sum = weights.reduce((a,b)=>a+b,0) || 1;
  const fracs = weights.map(w => w/sum);

  // 4) segments
  segments = [];
  let acc = 0;
  for(let i=0;i<n;i++){
    const start = acc*TWO_PI;
    const end = (acc + fracs[i])*TWO_PI;
    const center = (start+end)/2;
    segments.push({label:items[i].label, start, end, center, weight:weights[i]});
    acc += fracs[i];
  }
  drawWheel();
  syncEditor(); // update editor numbers (clean rounding)
}

/* ================== Drawing (with realistic rim) ================== */
function drawWheel(){
  const W=canvas.width,H=canvas.height;
  ctx.clearRect(0,0,W,H);
  ctx.save(); ctx.translate(W/2,H/2); ctx.rotate(angle);

  // radii
  const colorR = Math.min(W,H)/2 - 36;
  const rimOuter = colorR + 26;
  const rimInner = colorR + 6;
  const innerWhite = colorR + 2;

  // RIM dark housing + shadow
  ctx.save();
  ctx.shadowColor='rgba(0,0,0,.45)'; ctx.shadowBlur=18;
  ctx.beginPath(); ctx.arc(0,0,rimOuter,0,TWO_PI); ctx.fillStyle='#0a0c12'; ctx.fill();
  ctx.restore();

  // carve inner
  ctx.globalCompositeOperation='destination-out';
  ctx.beginPath(); ctx.arc(0,0,rimInner,0,TWO_PI); ctx.fill();
  ctx.globalCompositeOperation='source-over';

  // white ring
  ctx.beginPath(); ctx.arc(0,0,innerWhite,0,TWO_PI); ctx.strokeStyle='#fff'; ctx.lineWidth=6; ctx.stroke();

  // bolts
  for(let i=0;i<8;i++){
    const a=i*(TWO_PI/8); const r=(rimOuter+rimInner)/2; const x=Math.cos(a)*r, y=Math.sin(a)*r;
    ctx.beginPath(); ctx.arc(x,y,8,0,TWO_PI); ctx.fillStyle='#e6e8ef'; ctx.fill();
    ctx.beginPath(); ctx.arc(x,y,3.2,0,TWO_PI); ctx.fillStyle='#1b1e2a'; ctx.fill();
  }

  // segments
  if(segments.length===0){
    // placeholder
    ctx.beginPath(); ctx.arc(0,0,colorR,0,TWO_PI); ctx.fillStyle='#3b4a9e'; ctx.fill();
  }else{
    for(let i=0;i<segments.length;i++){
      const seg=segments[i];
      if(seg.end-seg.start<=0) continue; // zero-size skip
      const hue = Math.floor((360/segments.length)*i);
      ctx.beginPath(); ctx.moveTo(0,0); ctx.arc(0,0,colorR,seg.start,seg.end); ctx.closePath();
      ctx.fillStyle=`hsl(${hue} 75% 52%)`; ctx.fill();

      ctx.strokeStyle="rgba(5,10,30,.6)"; ctx.lineWidth=6;
      ctx.beginPath(); ctx.arc(0,0,colorR,seg.start,seg.end); ctx.stroke();

      // label
      ctx.save(); ctx.rotate(seg.center);
      const r = colorR*0.72;
      // badge
      ctx.fillStyle="rgba(4,7,22,.35)";
      roundedRect(ctx, r-92, -22, 184, 44, 12); ctx.fill();
      ctx.fillStyle="#fff"; ctx.textAlign="center"; ctx.textBaseline="middle";
      ctx.font="700 28px ui-sans-serif,system-ui,'Noto Sans KR'";
      ctx.fillText(seg.label, r, 0);
      ctx.restore();
    }
  }

  // hub
  ctx.beginPath(); ctx.arc(0,0,80,0,TWO_PI);
  const g=ctx.createRadialGradient(0,0,10,0,0,80); g.addColorStop(0,'#ff8a3d'); g.addColorStop(1,'#e4551a');
  ctx.fillStyle=g; ctx.fill();
  ctx.beginPath(); ctx.arc(0,0,90,0,TWO_PI); ctx.strokeStyle='rgba(255,255,255,.9)'; ctx.lineWidth=10; ctx.stroke();

  ctx.restore();
}
function roundedRect(ctx,x,y,w,h,r){
  ctx.beginPath();
  ctx.moveTo(x+r,y);
  ctx.arcTo(x+w,y,x+w,y+h,r);
  ctx.arcTo(x+w,y+h,x,y+h,r);
  ctx.arcTo(x,y+h,x,y,r);
  ctx.arcTo(x,y,x+w,y,r);
  ctx.closePath();
}

/* ================== Spin with exact stop ================== */
function pickIndexWeighted(){
  // choose by actual weights used in segments
  if(segments.length===0) return -1;
  const total = segments.reduce((a,s)=>a+(s.end-s.start),0);
  const x = Math.random()*total;
  let run=0;
  for(let i=0;i<segments.length;i++){
    const len = segments[i].end-segments[i].start;
    if(x < run+len) return i;
    run += len;
  }
  return segments.length-1;
}
function targetAngleForIndex(i){
  const center = segments[i].center;        // wheel-local center angle
  const desired = POINTER_ANGLE - center;   // where angle should be so that pointer hits center
  const delta = norm(desired - angle);      // positive rotation to reach it
  const turns = Math.floor(Math.random()*2)+6; // 6~7 turns
  return angle + turns*TWO_PI + delta;
}
function spin(){
  if(spinning || segments.length===0) return;
  hideResult(); spinning = true; btnCenterStart.disabled = true;

  const idx = pickIndexWeighted();
  const target = targetAngleForIndex(idx);
  const start = angle;
  const duration = 3600 + Math.random()*1400; // 3.6~5.0s
  const t0 = performance.now();

  (function anim(now){
    const t = clamp((now - t0)/duration, 0, 1);
    const ease = 1 - Math.pow(1 - t, 3); // easeOutCubic
    angle = start + (target - start)*ease;
    drawWheel();
    if(t<1) requestAnimationFrame(anim);
    else {
      angle = target; drawWheel(); // numeric fix
      onWin(idx);
      spinning = false; btnCenterStart.disabled = false;
    }
  })(t0);
}

/* ensure UI and pointer agree */
function getIndexAtPointer(){
  if(segments.length===0) return -1;
  const wheelAtPointer = norm(POINTER_ANGLE - angle); // wheel-local angle
  for(let i=0;i<segments.length;i++){
    const {start,end} = segments[i];
    if(start <= wheelAtPointer && wheelAtPointer < end) return i;
    // edge case when pointer exactly at end (due to rounding)
    if(i===segments.length-1 && Math.abs(wheelAtPointer - end) < 1e-6) return i;
  }
  return -1;
}

/* ================== Result / Log ================== */
function onWin(idx){
  const seg = segments[idx];
  // Double-check (safety): if mismatch, trust pointer
  const ptrIdx = getIndexAtPointer();
  const finalIdx = (ptrIdx>=0 ? ptrIdx : idx);
  const pick = segments[finalIdx].label;

  resultBadge.textContent = `ğŸ‰ ë‹¹ì²¨: ${pick}`;
  resultBadge.style.display = 'inline-block';

  // ê¸°ë¡ ì¶”ê°€
  historyLog.unshift({t:new Date(), v:pick});
  renderLog();

  // ì‚­ì œ ì˜µì…˜: ì¤‘ë³µ í—ˆìš© ì²´í¬ê°€ í•´ì œëœ ê²½ìš°ì—ë§Œ ì‚­ì œ
  if(!allowDuplicate){
    // remove from items by label (first match)
    const k = items.findIndex(o => o.label === pick);
    if(k>=0){ items.splice(k,1); rebuildSegments(); syncEditor(); }
  }
}
function hideResult(){ resultBadge.style.display='none' }
function renderLog(){
  if(logBox.style.display==='none') return;
  logBox.innerHTML = historyLog.slice(0,200).map(r=>`<div>â€¢ <b>${r.v}</b> <span style="opacity:.75">(${fmtTime(r.t)})</span></div>`).join('');
}

/* ================== Input / Editor ================== */
let composing=false, lastAdded='', lastAt=0;
ipt.addEventListener('compositionstart',()=>{composing=true;});
ipt.addEventListener('compositionend',()=>{composing=false;});
function sanitize(raw){
  let v=(raw||'').replace(/\s+/g,' ').trim().replace(/[,\u3001;\/\\]+$/,'').trim();
  if(v==='ë“±') return ''; return v;
}
function addItem(label){
  items.push({label, weight:null});
  ipt.value=''; syncEditor(); rebuildSegments();
}
function addFromInput(){
  if(composing) return;
  const v = sanitize(ipt.value);
  if(!v) return;
  const now=Date.now(); if(v===lastAdded && now-lastAt<300) return;
  lastAdded=v; lastAt=now;
  addItem(v);
}
document.getElementById('btnAdd').addEventListener('click', addFromInput);
ipt.addEventListener('keydown', e=>{
  if(e.key==='Enter' && !e.isComposing){ e.preventDefault(); addFromInput(); }
});

document.getElementById('btnToggleEditor').addEventListener('click', ()=>{
  const ed = document.getElementById('editor');
  ed.style.display = ed.style.display==='none' ? '' : 'none';
  // ìš”êµ¬ì‚¬í•­ 1: í•­ëª©ë³´ê¸°/ìˆ¨ê¸°ê¸° ê¸°ëŠ¥ í™•ì¸ (ë™ì‘ ë³´ì¥)
});

function syncEditor(){
  const tbody = editTableBody; tbody.innerHTML='';
  items.forEach((it,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="width:56%"><input data-i="${i}" class="edit-label input" value="${escapeHtml(it.label)}" /></td>
      <td style="width:24%"><input data-i="${i}" class="edit-weight" type="number" min="0" step="0.1" placeholder="ë¹„ì¤‘" value="${it.weight??''}"/></td>
      <td style="width:20%"><button class="btn btn-ghost btn-del" data-i="${i}">ì‚­ì œ</button></td>
    `;
    tbody.appendChild(tr);
  });
}
editTableBody.addEventListener('input', (e)=>{
  if(e.target.classList.contains('edit-label')){
    const i=+e.target.dataset.i; items[i].label = e.target.value;
  }else if(e.target.classList.contains('edit-weight')){
    const i=+e.target.dataset.i; const v=e.target.value;
    items[i].weight = (v===''? null : Number(v));
  }
});
editTableBody.addEventListener('click', (e)=>{
  if(e.target.classList.contains('btn-del')){
    const i=+e.target.dataset.i; items.splice(i,1); syncEditor(); rebuildSegments();
  }
});
document.getElementById('btnSave').addEventListener('click', ()=>{
  rebuildSegments(); // ì €ì¥ í›„ ë£°ë › ë°˜ì˜
  alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. ë£°ë ›ì— ë°˜ì˜í–ˆì–´ìš”.');
});

/* ================== File Load / Samples ================== */
document.getElementById('btnLoadFile').addEventListener('click', ()=> fileInput.click());
fileInput.addEventListener('change', async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const text = await f.text();
  const name = (f.name||'').toLowerCase();
  let parsed = [];
  if(name.endsWith('.csv')) parsed = parseCSV(text);
  else parsed = parseTXT(text);
  if(parsed.length===0){ alert('ì½ì€ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ ë‚´ìš©ì„ í™•ì¸í•˜ì„¸ìš”.'); return; }
  items = parsed;
  syncEditor(); rebuildSegments();
  fileInput.value='';
});
function parseTXT(s){
  const lines = s.split(/\r?\n/).map(v=>v.trim()).filter(Boolean);
  return lines.map(v=>({label:v, weight:null}));
}
function parseCSV(s){
  const lines = s.split(/\r?\n/).map(v=>v.trim()).filter(Boolean);
  const out=[];
  for(let i=0;i<lines.length;i++){
    const line = lines[i];
    if(i===0 && /label/i.test(line) && /weight|ë¹„ì¤‘/i.test(line)) continue; // header skip
    const [a,b] = line.split(',').map(x=>x?.trim());
    if(!a) continue;
    const w = (b===''||b==null) ? null : Number(b);
    out.push({label:a, weight: isNaN(w)? null : w});
  }
  return out;
}
document.getElementById('btnDownloadSamples').addEventListener('click', ()=>{
  const txt = `ì‚¬ê³¼\në°”ë‚˜ë‚˜\nì²´ë¦¬\ní¬ë„`;
  const csv = `label,weight\nì‚¬ê³¼,40\në°”ë‚˜ë‚˜,\nì²´ë¦¬,30\ní¬ë„,`;
  downloadBlob('sample.txt', txt, 'text/plain;charset=utf-8');
  downloadBlob('sample.csv', csv, 'text/csv;charset=utf-8');
});
function downloadBlob(filename, content, type){
  const blob = new Blob([content], {type});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = filename; a.click();
  URL.revokeObjectURL(url);
}

/* ================== Options / Records ================== */
document.getElementById('chkDupe').addEventListener('change', e=>{
  allowDuplicate = e.target.checked; // ì²´í¬ ì‹œ ì‚­ì œ ì•ˆ í•¨
});
document.getElementById('chkTheme').addEventListener('change', e=>{
  document.documentElement.setAttribute('data-theme', e.target.checked ? 'light' : 'dark');
});
document.getElementById('btnToggleLog').addEventListener('click', ()=>{
  logBox.style.display = logBox.style.display==='none' ? '' : 'none';
  renderLog();
});
document.getElementById('btnClearLog').addEventListener('click', ()=>{
  historyLog.length=0; renderLog();
});

/* ================== Controls ================== */
document.getElementById('btnReset').addEventListener('click', ()=>{
  angle=0; hideResult(); drawWheel();
});
document.getElementById('btnBig').addEventListener('click', ()=>{
  const w = window.open('', '_blank', 'width=1200,height=1000');
  w.document.write(bigHtml(document.documentElement.getAttribute('data-theme')||'dark', items, allowDuplicate, angle));
  w.document.close();
});
document.getElementById('btnCenterStart').addEventListener('click', spin);

/* ================== Big Screen ================== */
function bigHtml(theme, itemsInit, dupe, ang){
  // build a minimal page that rebuilds segments with the same rules
  return `
<!DOCTYPE html><html lang="ko" data-theme="${theme}"><head><meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" /><title>ëŒ€í˜• ë£°ë ›</title>
<style>
:root{--bg:#0a0d1f;--tx:#fff} html[data-theme="light"]{--bg:#f6f7fb;--tx:#101322}
html,body{height:100%;margin:0;background:var(--bg);color:var(--tx);font-family:ui-sans-serif,system-ui,'Noto Sans KR',sans-serif}
.stage{display:grid;place-items:center;height:100%;gap:16px}
.pointer{width:0;height:0;border-left:20px solid transparent;border-right:20px solid transparent;border-top:30px solid #ff5a5a;filter:drop-shadow(0 10px 14px rgba(0,0,0,.45))}
canvas{width:min(92vmin,1200px);height:min(92vmin,1200px)}
.controls{position:fixed;right:16px;top:16px;display:flex;gap:8px}
.btn{all:unset;background:#1a1f42d9;border:1px solid #3a47b8aa;padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:800}
html[data-theme="light"] .btn{background:#ffffffdd;border-color:#c9d1ff;color:#1a237e}
</style></head><body>
<div class="controls"><button class="btn" id="start">â–¶ ì‹œì‘</button><button class="btn" id="reset">â†º ì´ˆê¸°í™”</button></div>
<div class="stage"><div class="pointer"></div><canvas id="C" width="1400" height="1400"></canvas></div>
<script>
const TWO_PI=Math.PI*2, POINTER_ANGLE=-Math.PI/2;
const C=document.getElementById('C'), X=C.getContext('2d');
let items=${JSON.stringify(itemsInit)}, allow=${dupe?'true':'false'}, angle=${ang||0}, spinning=false, seg=[];
function rebuild(){
  if(items.length===0){seg=[]; draw(); return;}
  let sum=0, uns=[]; const w=new Array(items.length).fill(0);
  for(let i=0;i<items.length;i++){ const x=Number(items[i].weight); if(x>0){w[i]=x; sum+=x;} else uns.push(i); }
  if(sum===0){ for(let i=0;i<items.length;i++) w[i]=100/items.length; }
  else{ const rem=Math.max(0,100-sum); const share=uns.length? rem/uns.length : 0; for(const i of uns) w[i]=share; }
  const s=w.reduce((a,b)=>a+b,0)||1; const f=w.map(v=>v/s);
  seg=[]; let a=0; for(let i=0;i<items.length;i++){ const st=a*TWO_PI, en=(a+f[i])*TWO_PI; seg.push({label:items[i].label,start:st,end:en,center:(st+en)/2}); a+=f[i]; }
  draw();
}
function draw(){
  const W=C.width,H=C.height; X.clearRect(0,0,W,H); X.save(); X.translate(W/2,H/2); X.rotate(angle);
  const R=Math.min(W,H)/2-36, rimO=R+26, rimI=R+6, innerW=R+2;
  // rim
  X.save(); X.shadowColor='rgba(0,0,0,.45)'; X.shadowBlur=18; X.beginPath(); X.arc(0,0,rimO,0,TWO_PI); X.fillStyle='#0a0c12'; X.fill(); X.restore();
  X.globalCompositeOperation='destination-out'; X.beginPath(); X.arc(0,0,rimI,0,TWO_PI); X.fill(); X.globalCompositeOperation='source-over';
  X.beginPath(); X.arc(0,0,innerW,0,TWO_PI); X.strokeStyle='#fff'; X.lineWidth=6; X.stroke();
  for(let i=0;i<8;i++){ const a=i*(TWO_PI/8), r=(rimO+rimI)/2, x=Math.cos(a)*r, y=Math.sin(a)*r;
    X.beginPath(); X.arc(x,y,8,0,TWO_PI); X.fillStyle='#e6e8ef'; X.fill();
    X.beginPath(); X.arc(x,y,3.2,0,TWO_PI); X.fillStyle='#1b1e2a'; X.fill();
  }
  if(seg.length){
    for(let i=0;i<seg.length;i++){
      const s=seg[i]; const hue=Math.floor((360/seg.length)*i);
      X.beginPath(); X.moveTo(0,0); X.arc(0,0,R,s.start,s.end); X.closePath(); X.fillStyle=\`hsl(\${hue} 75% 52%)\`; X.fill();
      X.strokeStyle='rgba(5,10,30,.55)'; X.lineWidth=6; X.beginPath(); X.arc(0,0,R,s.start,s.end); X.stroke();
      X.save(); X.rotate(s.center); X.fillStyle='#fff'; X.font="700 42px ui-sans-serif,'Noto Sans KR'";
      X.textAlign='center'; X.textBaseline='middle'; X.fillText(s.label, R*0.72, 0); X.restore();
    }
  }else{ X.beginPath(); X.arc(0,0,R,0,TWO_PI); X.fillStyle='#3b4a9e'; X.fill(); }
  // hub
  X.beginPath(); X.arc(0,0,80,0,TWO_PI);
  const g=X.createRadialGradient(0,0,10,0,0,80); g.addColorStop(0,'#ff8a3d'); g.addColorStop(1,'#e4551a');
  X.fillStyle=g; X.fill(); X.beginPath(); X.arc(0,0,90,0,TWO_PI); X.strokeStyle='rgba(255,255,255,.9)'; X.lineWidth=10; X.stroke();
  X.restore();
}
function target(i){ const d=POINTER_ANGLE - seg[i].center; const delta=((d-angle)%TWO_PI+TWO_PI)%TWO_PI; return angle + 6*TWO_PI + delta; }
function pick(){ const tot=seg.reduce((a,s)=>a+(s.end-s.start),0); const x=Math.random()*tot; let r=0; for(let i=0;i<seg.length;i++){const len=seg[i].end-seg[i].start; if(x<r+len) return i; r+=len;} return seg.length-1; }
function spin(){ if(spinning||seg.length===0) return; spinning=true; const i=pick(); const tgt=target(i); const st=angle, dur=3800+Math.random()*1200, t0=performance.now();
 (function anim(now){ const t=Math.min((now-t0)/dur,1); const ease=1-Math.pow(1-t,3); angle=st+(tgt-st)*ease; draw(); if(t<1) requestAnimationFrame(anim); else { angle=tgt; draw(); if(!allow){ const k=items.findIndex(o=>o.label===seg[i].label); if(k>=0) items.splice(k,1); rebuild(); } spinning=false; } })(t0); }
document.getElementById('start').onclick=spin; document.getElementById('reset').onclick=()=>{angle=0; draw();};
rebuild();
<\/script></body></html>`;
}

/* ================== Helpers ================== */
function escapeHtml(s){ return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m]); }

/* ================== Init ================== */
rebuildSegments(); // start empty
drawWheel();

/* ================== Events ================== */
document.getElementById('btnToggleLog').addEventListener('click', renderLog);
document.getElementById('btnCenterStart').addEventListener('click', spin);
</script>
</body>
</html>
