<!DOCTYPE html>
<html lang="ko" data-theme="dark">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>룰렛 프로그램 | Roullet</title>
<style>
  :root{
    --bg-1:#0f1220; --bg-2:#171a2b; --panel:#1b2142cc;
    --text:#e9ecf1; --muted:#9aa3b2;
    --primary:#5865F2; --primary-2:#7c8bff;
    --ring:0 0 0 3px rgba(88,101,242,.28);
    --shadow:0 10px 30px rgba(0,0,0,.35);
    --radius:16px;
    --input-bg:#0f1433; --input-br:#2f3566;
    --btn1:#2a33a8; --btn2:#1b2088; --btn-br:#4b57ff66;
    --ghost-bg:#0e1435; --ghost-br:#2d3470; --ghost-tx:#d7dcff;
    --panel-line:#2a2f55; --section-bg:#12173180;
  }
  html[data-theme="light"]{
    --bg-1:#f6f7fb; --bg-2:#eef1fb; --panel:#ffffffee;
    --text:#101322; --muted:#4b5570;
    --primary:#3743d9; --primary-2:#4d5cff;
    --ring:0 0 0 3px rgba(77,92,255,.25);
    --shadow:0 10px 30px rgba(10,14,40,.12);
    --input-bg:#ffffff; --input-br:#c9cfef;
    --ghost-bg:#f3f5ff; --ghost-br:#c9d1ff; --ghost-tx:#1a237e;
    --panel-line:#e2e7ff; --section-bg:#f7f8ff;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--text);
    font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR","Apple SD Gothic Neo","Malgun Gothic",sans-serif;
    background:
      radial-gradient(1200px 600px at 20% 0%, #1f294e33, transparent 60%),
      radial-gradient(800px 600px at 100% 100%, #2a3a8a30, transparent 60%),
      linear-gradient(180deg,var(--bg-1),var(--bg-2));
  }

  /* 레이아웃 */
  .wrap{display:grid;grid-template-columns:minmax(360px,1fr) 480px;gap:20px;height:100%;padding:20px}
  .panel{background:var(--panel);backdrop-filter:blur(8px);border:1px solid var(--panel-line);border-radius:var(--radius);box-shadow:var(--shadow)}
  .left{position:relative;display:grid;grid-template-rows:auto 1fr;align-items:center;justify-items:center;padding:24px}
  .title{width:100%;display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
  .title h1{font-size:18px;font-weight:800;margin:0;letter-spacing:.2px;opacity:.9}

  /* 캔버스 박스 */
  .canvas-box{position:relative;width:min(90vmin, 920px);aspect-ratio:1/1;display:grid;place-items:center}
  canvas{width:100%;height:100%;z-index:10}

  /* 포인터(역삼각형) — 컨테이너 기준 고정 */
  .pointer{
    position:absolute; top:-6px; left:50%; transform:translateX(-50%);
    width:0;height:0;border-left:18px solid transparent;border-right:18px solid transparent;border-top:28px solid #ff5a5a;
    filter:drop-shadow(0 10px 14px rgba(0,0,0,.45)); z-index:50;
  }

  /* 중앙 시작 버튼 */
  .center-start{
    position:absolute; inset:auto; width:160px; height:160px; border-radius:50%;
    display:grid; place-items:center; font-weight:900; font-size:22px; color:#fff;
    background: radial-gradient(circle at 35% 30%, #ffa142, #ff7a1f 60%, #e4551a 100%);
    border:10px solid #fff; box-shadow:0 14px 24px rgba(0,0,0,.35); cursor:pointer; user-select:none; z-index:40;
  }
  .center-start:disabled{ filter:grayscale(.4) brightness(.9); cursor:not-allowed; }

  /* 결과: 하단 중앙 — 항상 최상단 */
  .result-overlay{
    position:absolute; left:0; right:0; bottom:10px; display:grid; place-items:center; pointer-events:none; z-index:60;
  }
  .result-badge{
    display:none; padding:12px 16px; border-radius:12px;
    font-size:34px; font-weight:900; color:#fff;
    background:#0b1139e6; border:2px solid #3b4bd4a6; box-shadow:0 18px 32px rgba(0,0,0,.45);
  }

  /* 오른쪽 패널 */
  .right{display:flex;flex-direction:column;padding:18px;gap:14px}
  .section{padding:14px;border-radius:12px;background:var(--section-bg);border:1px solid var(--panel-line)}
  .section h2{font-size:14px;font-weight:800;letter-spacing:.4px;margin:0 0 10px 0;color:var(--primary-2);text-transform:uppercase}
  .input-row{display:flex;gap:10px;align-items:center}
  .input{flex:1;padding:12px 14px;border-radius:12px;border:1px solid var(--input-br);background:var(--input-bg);color:var(--text);outline:none;transition:box-shadow .15s,border-color .15s;font-size:15px}
  .input::placeholder{color:var(--muted)} .input:focus{box-shadow:var(--ring);border-color:var(--primary-2)}

  /* 버튼 */
  .btn{all:unset;display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 12px;border-radius:12px;cursor:pointer;color:#fff;font-weight:800;font-size:14px;background:var(--ghost-bg);border:1px solid var(--ghost-br);box-shadow:none;transition:transform .08s ease,filter .2s ease}
  .btn:active{transform:translateY(1px)} .btn:hover{filter:brightness(1.05)}
  .btn-primary{background:linear-gradient(180deg,var(--btn1),var(--btn2));border:1px solid var(--btn-br);box-shadow:0 10px 20px rgba(37,48,140,.35)}
  .btn-s{padding:8px 10px;font-size:12.5px;border-radius:10px}

  .note{color:var(--muted);font-size:12px}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}

  /* 항목 편집 테이블 */
  .table{border:1px solid var(--panel-line);border-radius:12px;padding:10px;background:linear-gradient(180deg,transparent,rgba(255,255,255,.02))}
  table{width:100%;border-collapse:separate;border-spacing:0 4px}
  th,td{padding:6px 6px;font-size:14px}
  th{color:var(--muted);font-weight:700}
  .td-index{width:34px;color:var(--muted);text-align:right;padding-right:8px}
  .td-label input{width:100%;padding:8px 10px;border-radius:10px;border:1px solid var(--input-br);background:var(--input-bg);color:var(--text)}
  .td-weight input{width:80px;padding:8px;border-radius:10px;border:1px solid var(--input-br);background:var(--input-bg);color:var(--text);text-align:right}
  .td-actions{width:46px;text-align:right}
  .icon-btn{all:unset;display:inline-grid;place-items:center;width:34px;height:34px;border-radius:10px;border:1px solid var(--ghost-br);background:var(--ghost-bg);cursor:pointer}
  .icon-btn:hover{filter:brightness(1.05)}

  .toolbar{display:flex;gap:8px;justify-content:flex-end;margin:-2px 0 8px}
  .hidden{display:none !important}
  @media (max-width:980px){.wrap{grid-template-columns:1fr}}
</style>
</head>
<body>
  <div class="wrap">
    <!-- LEFT -->
    <div class="panel left">
      <div class="title">
        <h1>🎡 룰렛</h1>
        <div style="display:flex;gap:8px">
          <button class="btn btn-s" id="btnReset">↺ 초기화</button>
          <button class="btn btn-s" id="btnBig">🖥 대형</button>
        </div>
      </div>

      <div class="canvas-box" id="canvasBox">
        <div class="pointer" aria-hidden="true"></div>
        <canvas id="wheel" width="920" height="920"></canvas>
        <button id="btnCenterStart" class="center-start">시작하기</button>
        <div class="result-overlay"><div id="resultBadge" class="result-badge"></div></div>
      </div>
    </div>

    <!-- RIGHT -->
    <aside class="panel right">
      <div class="section">
        <h2>입력 · 불러오기</h2>
        <div class="input-row">
          <input id="itemInput" class="input" type="text" placeholder="한 줄에 1개 입력 후 Enter" />
          <button class="btn btn-primary" id="btnAdd">+ 추가</button>
        </div>

        <div class="grid-2" style="margin-top:8px">
          <button class="btn" id="btnToggleList">👁 항목 보기/숨기기</button>
          <button class="btn" id="btnLoadFile">📁 파일 불러오기 (.txt/.csv)</button>
          <input id="fileInput" type="file" accept=".txt,.csv" class="hidden" />
          <button class="btn" id="btnDownloadSamples">⬇ 샘플 내려받기</button>
          <button class="btn" id="btnSave">💾 저장하기</button>
        </div>

        <div class="note" style="margin-top:6px">• TXT: 줄마다 항목 · CSV: <code>label,weight</code> (weight 생략 가능)</div>

        <!-- 항목+비중 편집 테이블 -->
        <div id="editorWrap" class="table hidden" style="margin-top:10px">
          <div class="toolbar">
            <button class="btn btn-s" id="btnClearWeight">전체 비중 지우기</button>
          </div>
          <table>
            <thead>
              <tr><th class="td-index">#</th><th>항목</th><th style="width:100px">비중</th><th class="td-actions"></th></tr>
            </thead>
            <tbody id="itemTable"></tbody>
          </table>
        </div>
      </div>

      <!-- 옵션 & 기록 -->
      <div class="section">
        <h2>옵션</h2>
        <label style="display:flex;align-items:center;gap:10px;margin-top:6px">
          <input id="chkDupe" type="checkbox" checked /> 뽑기 중복 허용(체크 시 당첨 후 삭제 안 함)
        </label>
        <label style="display:flex;align-items:center;gap:10px;margin-top:6px">
          <input id="chkTheme" type="checkbox" /> 밝은(프로젝터) 모드
        </label>
      </div>
      <div class="section">
        <h2>추첨 기록</h2>
        <div style="display:flex;gap:8px;margin-bottom:8px">
          <button class="btn btn-s" id="btnToggleLog">📝 기록 보기/숨기기</button>
          <button class="btn btn-s" id="btnClearLog">🗑 삭제</button>
        </div>
        <div id="logBox" class="hidden" style="max-height:180px;overflow:auto;font-size:13px;opacity:.9"></div>
      </div>
    </aside>
  </div>

<script>
/* ===== Helpers ===== */
const TWO_PI=Math.PI*2, POINTER_ANGLE=-Math.PI/2;
const qs=id=>document.getElementById(id);
const norm=a=> (a%TWO_PI + TWO_PI)%TWO_PI;
const escapeHtml=s=>(s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
const fmtTime=d=>{const p=n=>String(n).padStart(2,'0');return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}`};
const show=el=>el.classList.remove('hidden'); const hide=el=>el.classList.add('hidden'); const toggle=el=>el.classList.toggle('hidden');

/* ===== State ===== */
let items=[];         // [{label, weight:null|number}]
let segments=[];      // built from items
let allowDuplicate=true;
let angle=0, spinning=false;
const historyLog=[];

/* ===== DOM ===== */
const canvas=qs('wheel'), ctx=canvas.getContext('2d');
const ipt=qs('itemInput');
const resultBadge=qs('resultBadge');
const editorWrap=qs('editorWrap'); const itemTable=qs('itemTable');
const logBox=qs('logBox'); const fileInput=qs('fileInput');

/* ===== Build segments (weights) ===== */
function rebuildSegments(){
  if(items.length===0){ segments=[]; drawWheel(); return; }
  const n=items.length, weights=new Array(n).fill(0), unspecified=[];
  let sumSpecified=0;
  for(let i=0;i<n;i++){
    const w=Number(items[i].weight);
    if(!isNaN(w) && w>0){ weights[i]=w; sumSpecified+=w; } else unspecified.push(i);
  }
  if(sumSpecified===0){ for(let i=0;i<n;i++) weights[i]=100/n; }
  else{
    const rem=Math.max(0,100-sumSpecified); const share=unspecified.length? rem/unspecified.length : 0;
    for(const i of unspecified) weights[i]=share;
  }
  const sum=weights.reduce((a,b)=>a+b,0)||1; const fracs=weights.map(w=>w/sum);
  segments=[]; let acc=0;
  for(let i=0;i<n;i++){
    const start=acc*TWO_PI, end=(acc+fracs[i])*TWO_PI;
    segments.push({label:items[i].label,start,end,center:(start+end)/2,weight:weights[i]}); acc+=fracs[i];
  }
  drawWheel();
}

/* ===== Draw wheel (rim + slices) ===== */
function drawWheel(){
  const W=canvas.width,H=canvas.height;
  ctx.clearRect(0,0,W,H);
  ctx.save(); ctx.translate(W/2,H/2); ctx.rotate(angle);
  const R=Math.min(W,H)/2-36;
  const rimO=R+26,rimI=R+6, innerW=R+2;

  // rim + shadow
  ctx.save(); ctx.shadowColor='rgba(0,0,0,.45)'; ctx.shadowBlur=18;
  ctx.beginPath(); ctx.arc(0,0,rimO,0,TWO_PI); ctx.fillStyle='#0a0c12'; ctx.fill(); ctx.restore();
  // carve
  ctx.globalCompositeOperation='destination-out'; ctx.beginPath(); ctx.arc(0,0,rimI,0,TWO_PI); ctx.fill();
  ctx.globalCompositeOperation='source-over';
  // inner ring
  ctx.beginPath(); ctx.arc(0,0,innerW,0,TWO_PI); ctx.strokeStyle='#fff'; ctx.lineWidth=6; ctx.stroke();
  // bolts
  for(let i=0;i<8;i++){ const a=i*(TWO_PI/8), r=(rimO+rimI)/2, x=Math.cos(a)*r, y=Math.sin(a)*r;
    ctx.beginPath(); ctx.arc(x,y,8,0,TWO_PI); ctx.fillStyle='#e6e8ef'; ctx.fill();
    ctx.beginPath(); ctx.arc(x,y,3.2,0,TWO_PI); ctx.fillStyle='#1b1e2a'; ctx.fill();
  }
  if(segments.length){
    for(let i=0;i<segments.length;i++){
      const s=segments[i], hue=Math.floor((360/segments.length)*i);
      ctx.beginPath(); ctx.moveTo(0,0); ctx.arc(0,0,R,s.start,s.end); ctx.closePath();
      ctx.fillStyle=`hsl(${hue} 75% 52%)`; ctx.fill();
      ctx.strokeStyle="rgba(5,10,30,.6)"; ctx.lineWidth=6; ctx.beginPath(); ctx.arc(0,0,R,s.start,s.end); ctx.stroke();

      ctx.save(); ctx.rotate(s.center);
      const rr=R*0.72;
      roundedRect(ctx, rr-92, -22, 184, 44, 12); ctx.fillStyle="rgba(4,7,22,.35)"; ctx.fill();
      ctx.fillStyle="#fff"; ctx.textAlign="center"; ctx.textBaseline="middle";
      ctx.font="700 28px ui-sans-serif,system-ui,'Noto Sans KR'"; ctx.fillText(s.label, rr, 0);
      ctx.restore();
    }
  }else{
    ctx.beginPath(); ctx.arc(0,0,R,0,TWO_PI); ctx.fillStyle='#3b4a9e'; ctx.fill();
  }
  // hub
  ctx.beginPath(); ctx.arc(0,0,80,0,TWO_PI);
  const g=ctx.createRadialGradient(0,0,10,0,0,80); g.addColorStop(0,'#ff8a3d'); g.addColorStop(1,'#e4551a'); ctx.fillStyle=g; ctx.fill();
  ctx.beginPath(); ctx.arc(0,0,90,0,TWO_PI); ctx.strokeStyle='rgba(255,255,255,.9)'; ctx.lineWidth=10; ctx.stroke();
  ctx.restore();
}
function roundedRect(ctx,x,y,w,h,r){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); }

/* ===== Spin (ease-out + exact stop) ===== */
function pickIndexWeighted(){
  const total=segments.reduce((a,s)=>a+(s.end-s.start),0);
  let r=Math.random()*total, acc=0;
  for(let i=0;i<segments.length;i++){ const len=segments[i].end-segments[i].start; if(r<acc+len) return i; acc+=len; }
  return segments.length-1;
}
function targetAngleForIndex(i){
  const desired = POINTER_ANGLE - segments[i].center;
  const delta = norm(desired - angle);
  const turns = 6 + Math.floor(Math.random()*2); // 6~7바퀴
  return angle + turns*TWO_PI + delta;
}
function spin(){
  if(spinning || segments.length===0) return;
  hide(resultBadge); spinning=true; qs('btnCenterStart').disabled=true;
  const idx=pickIndexWeighted(); const target=targetAngleForIndex(idx);
  const start=angle, duration=3600+Math.random()*1400, t0=performance.now();
  (function anim(now){
    const t=Math.min((now-t0)/duration,1), ease=1-Math.pow(1-t,3);
    angle=start+(target-start)*ease; drawWheel();
    if(t<1) requestAnimationFrame(anim); else { angle=target; drawWheel(); onWin(idx); spinning=false; qs('btnCenterStart').disabled=false; }
  })(t0);
}
function getIndexAtPointer(){
  const a=norm(POINTER_ANGLE - angle);
  for(let i=0;i<segments.length;i++){ const s=segments[i]; if(s.start<=a && a<s.end) return i; if(i===segments.length-1 && Math.abs(a-s.end)<1e-6) return i; }
  return -1;
}
function onWin(idx){
  const ptr=getIndexAtPointer(); const final=ptr>=0?ptr:idx;
  const pick=segments[final].label;
  resultBadge.textContent = `🎉 ${pick}`; show(resultBadge);
  historyLog.unshift({t:new Date(), v:pick}); renderLog();
  if(!allowDuplicate){
    const k=items.findIndex(o=>o.label===pick); if(k>=0){ items.splice(k,1); rebuildSegments(); renderEditor(); }
  }
}

/* ===== Editor (same section) ===== */
function renderEditor(){
  itemTable.innerHTML = items.length ? items.map((o,i)=>`
    <tr>
      <td class="td-index">${i+1}.</td>
      <td class="td-label"><input data-k="${i}" class="ipt-label" value="${escapeHtml(o.label)}" /></td>
      <td class="td-weight"><input data-k="${i}" class="ipt-weight" type="number" min="0" step="0.1" placeholder="-" value="${o.weight??''}"/></td>
      <td class="td-actions">
        <button class="icon-btn btn-del" title="삭제" data-k="${i}">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M3 6h18M9 6V4a2 2 0 012-2h2a2 2 0 012 2v2m1 0l-1 14a2 2 0 01-2 2H8a2 2 0 01-2-2L5 6" stroke="#d7dcff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M10 11v6M14 11v6" stroke="#d7dcff" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </td>
    </tr>`).join('') : `<tr><td colspan="4" style="opacity:.7;padding:12px">항목이 없습니다.</td></tr>`;
}
function showEditor(){ renderEditor(); show(editorWrap); }
function hideEditor(){ hide(editorWrap); }

/* 입력 */
let composing=false;
ipt.addEventListener('compositionstart',()=>{composing=true;});
ipt.addEventListener('compositionend',()=>{composing=false;});
function addFromInput(){
  if(composing) return;
  let v=(ipt.value||'').replace(/\s+/g,' ').trim(); if(!v) return;
  items.push({label:v, weight:null}); ipt.value='';
  showEditor(); rebuildSegments();
}
qs('btnAdd').addEventListener('click', addFromInput);
ipt.addEventListener('keydown', e=>{ if(e.key==='Enter' && !e.isComposing){ e.preventDefault(); addFromInput(); }});

/* 테이블 편집 이벤트 */
itemTable.addEventListener('input', e=>{
  if(e.target.classList.contains('ipt-weight')){
    const k=+e.target.dataset.k; const v=e.target.value; items[k].weight = (v===''? null : Number(v));
  }
  if(e.target.classList.contains('ipt-label')){
    const k=+e.target.dataset.k; items[k].label = e.target.value;
  }
});
itemTable.addEventListener('click', e=>{
  if(e.target.closest('.btn-del')){
    const k=+e.target.closest('.btn-del').dataset.k; items.splice(k,1); renderEditor(); rebuildSegments();
    if(!items.length) hideEditor();
  }
});

/* 저장 / 전체 비중 지우기 */
qs('btnSave').addEventListener('click', ()=>{ rebuildSegments(); hideEditor(); alert('저장 완료! 룰렛에 반영했습니다.'); });
qs('btnClearWeight').addEventListener('click', ()=>{ items.forEach(o=>o.weight=null); renderEditor(); rebuildSegments(); });

/* 항목 보기/숨기기 */
qs('btnToggleList').addEventListener('click', ()=>{ if(editorWrap.classList.contains('hidden')) renderEditor(); toggle(editorWrap); });

/* 기록 */
function renderLog(){
  if(logBox.classList.contains('hidden')) return;
  logBox.innerHTML = historyLog.map(r=>`<div>• <b>${escapeHtml(r.v)}</b> <span style="opacity:.75">(${fmtTime(r.t)})</span></div>`).join('');
}
qs('btnToggleLog').addEventListener('click', ()=>{ toggle(logBox); renderLog(); });
qs('btnClearLog').addEventListener('click', ()=>{ historyLog.length=0; renderLog(); });

/* 옵션 */
qs('chkDupe').addEventListener('change', e=>{ allowDuplicate=e.target.checked; });
qs('chkTheme').addEventListener('change', e=>{ document.documentElement.setAttribute('data-theme', e.target.checked ? 'light' : 'dark'); });

/* 파일 IO */
qs('btnLoadFile').addEventListener('click', ()=> fileInput.click());
fileInput.addEventListener('change', async (e)=>{
  const f=e.target.files[0]; if(!f) return;
  try{
    const text=await f.text(); const name=(f.name||'').toLowerCase();
    let parsed=[]; if(name.endsWith('.csv')) parsed=parseCSV(text); else parsed=parseTXT(text);
    if(!parsed.length){ alert('파일에서 항목을 찾지 못했습니다.'); return; }
    items=parsed; showEditor(); rebuildSegments();
  }catch(err){ alert('파일 읽기 오류'); console.error(err); }
  fileInput.value='';
});
function parseTXT(s){ return s.split(/\r?\n/).map(v=>v.trim()).filter(Boolean).map(v=>({label:v,weight:null})); }
function parseCSV(s){
  const lines=s.split(/\r?\n/).map(v=>v.trim()).filter(Boolean), out=[];
  for(let i=0;i<lines.length;i++){
    const line=lines[i]; if(i===0 && /label/i.test(line) && /weight|비중/i.test(line)) continue;
    const [a,b]=(line.split(',')||[]).map(x=>x?.trim()); if(!a) continue;
    const w=(b==null||b==='')? null : Number(b); out.push({label:a, weight:isNaN(w)? null : w});
  } return out;
}
qs('btnDownloadSamples').addEventListener('click', ()=>{
  const txt=`사과\n바나나\n체리\n포도`;
  const csv=`label,weight\n사과,40\n바나나,\n체리,30\n포도,`;
  download('sample.txt',txt,'text/plain;charset=utf-8'); download('sample.csv',csv,'text/csv;charset=utf-8');
});
function download(name,content,type){ const blob=new Blob([content],{type}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=name; a.click(); URL.revokeObjectURL(url); }

/* 컨트롤 */
qs('btnReset').addEventListener('click', ()=>{ angle=0; hide(resultBadge); drawWheel(); });
qs('btnCenterStart').addEventListener('click', spin);
qs('btnBig').addEventListener('click', ()=>{
  const w = window.open('', '_blank', 'width=1200,height=1000');
  w.document.write(bigHtml(document.documentElement.getAttribute('data-theme')||'dark', items, allowDuplicate, angle)); w.document.close();
});

/* 대형 화면 */
function bigHtml(theme, itemsInit, dupe, ang){
  return `<!DOCTYPE html><html lang="ko" data-theme="${theme}"><head><meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" /><title>대형 룰렛</title>
<style>
:root{--bg:#0a0d1f;--tx:#fff} html[data-theme="light"]{--bg:#f6f7fb;--tx:#101322}
html,body{height:100%;margin:0;background:var(--bg);color:var(--tx);font-family:ui-sans-serif,system-ui,'Noto Sans KR',sans-serif}
.stage{position:relative;display:grid;place-items:center;height:100%}
.pointer{position:absolute; top:-8px; left:50%; transform:translateX(-50%);
  width:0;height:0;border-left:20px solid transparent;border-right:20px solid transparent;border-top:30px solid #ff5a5a;
  filter:drop-shadow(0 10px 14px rgba(0,0,0,.45)); z-index:50;}
canvas{width:min(92vmin,1200px);height:min(92vmin,1200px);z-index:10}
.controls{position:fixed;right:16px;top:16px;display:flex;gap:8px;z-index:70}
.btn{all:unset;background:#1a1f42d9;border:1px solid #3a47b8aa;padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:800;color:#fff}
html[data-theme="light"] .btn{background:#ffffffdd;border-color:#c9d1ff;color:#1a237e}
.result{position:fixed;left:0;right:0;bottom:18px;display:grid;place-items:center;z-index:60}
.result > div{padding:16px 22px;border-radius:16px;font-size:40px;font-weight:900;color:#fff;background:#0b1139e6;border:2px solid #3b4bd4a6;box-shadow:0 18px 32px rgba(0,0,0,.45)}
</style></head><body>
<div class="controls"><button class="btn" id="start">▶ 시작</button><button class="btn" id="reset">↺ 초기화</button></div>
<div class="stage">
  <div class="pointer"></div>
  <canvas id="C" width="1400" height="1400"></canvas>
</div>
<div class="result"><div id="R" style="display:none"></div></div>
<script>
const TWO_PI=Math.PI*2, POINTER_ANGLE=-Math.PI/2;
const C=document.getElementById('C'), X=C.getContext('2d');
let items=${JSON.stringify(itemsInit)}, allow=${dupe?'true':'false'}, angle=${ang||0}, spinning=false, seg=[];
function rebuild(){
  let sum=0, uns=[], w=new Array(items.length).fill(0);
  for(let i=0;i<items.length;i++){ const x=Number(items[i].weight); if(x>0){w[i]=x; sum+=x;} else uns.push(i); }
  if(items.length===0){seg=[]; draw(); return;}
  if(sum===0){ for(let i=0;i<items.length;i++) w[i]=100/items.length; }
  else{ const rem=Math.max(0,100-sum), share=uns.length? rem/uns.length : 0; for(const i of uns) w[i]=share; }
  const s=w.reduce((a,b)=>a+b,0)||1, f=w.map(v=>v/s);
  seg=[]; let a=0; for(let i=0;i<items.length;i++){ const st=a*TWO_PI, en=(a+f[i])*TWO_PI; seg.push({label:items[i].label,start:st,end:en,center:(st+en)/2}); a+=f[i]; }
  draw();
}
function draw(){
  const W=C.width,H=C.height; X.clearRect(0,0,W,H); X.save(); X.translate(W/2,H/2); X.rotate(angle);
  const R=Math.min(W,H)/2-36, rimO=R+26, rimI=R+6, innerW=R+2;
  X.save(); X.shadowColor='rgba(0,0,0,.45)'; X.shadowBlur=18; X.beginPath(); X.arc(0,0,rimO,0,TWO_PI); X.fillStyle='#0a0c12'; X.fill(); X.restore();
  X.globalCompositeOperation='destination-out'; X.beginPath(); X.arc(0,0,rimI,0,TWO_PI); X.fill(); X.globalCompositeOperation='source-over';
  X.beginPath(); X.arc(0,0,innerW,0,TWO_PI); X.strokeStyle='rgba(255,255,255,.9)'; X.lineWidth=6; X.stroke();
  for(let i=0;i<8;i++){ const a=i*(TWO_PI/8), r=(rimO+rimI)/2, x=Math.cos(a)*r, y=Math.sin(a)*r;
    X.beginPath(); X.arc(x,y,8,0,TWO_PI); X.fillStyle='#e6e8ef'; X.fill();
    X.beginPath(); X.arc(x,y,3.2,0,TWO_PI); X.fillStyle='#1b1e2a'; X.fill();
  }
  if(seg.length){
    for(let i=0;i<seg.length;i++){
      const s=seg[i], hue=Math.floor((360/seg.length)*i);
      X.beginPath(); X.moveTo(0,0); X.arc(0,0,R,s.start,s.end); X.closePath(); X.fillStyle=\`hsl(\${hue} 75% 52%)\`; X.fill();
      X.strokeStyle='rgba(5,10,30,.55)'; X.lineWidth=6; X.beginPath(); X.arc(0,0,R,s.start,s.end); X.stroke();
      X.save(); X.rotate(s.center); X.fillStyle='#fff'; X.font="700 42px ui-sans-serif,'Noto Sans KR'"; X.textAlign='center'; X.textBaseline='middle'; X.fillText(s.label, R*0.72, 0); X.restore();
    }
  } else { X.beginPath(); X.arc(0,0,R,0,TWO_PI); X.fillStyle='#3b4a9e'; X.fill(); }
  X.beginPath(); X.arc(0,0,80,0,TWO_PI); const g=X.createRadialGradient(0,0,10,0,0,80); g.addColorStop(0,'#ff8a3d'); g.addColorStop(1,'#e4551a'); X.fillStyle=g; X.fill();
  X.beginPath(); X.arc(0,0,90,0,TWO_PI); X.strokeStyle='rgba(255,255,255,.9)'; X.lineWidth=10; X.stroke();
  X.restore();
}
function target(i){ const desired=POINTER_ANGLE - seg[i].center; const delta=((desired-angle)%TWO_PI+TWO_PI)%TWO_PI; const turns=6+Math.floor(Math.random()*2); return angle + turns*TWO_PI + delta; }
function pick(){ const tot=seg.reduce((a,s)=>a+(s.end-s.start),0); let r=Math.random()*tot, acc=0; for(let i=0;i<seg.length;i++){ const len=seg[i].end-seg[i].start; if(r<acc+len) return i; acc+=len; } return seg.length-1; }
function getIndexAtPointer(){ const a=((POINTER_ANGLE-angle)%TWO_PI+TWO_PI)%TWO_PI; for(let i=0;i<seg.length;i++){const s=seg[i]; if(s.start<=a && a<s.end) return i; if(i===seg.length-1 && Math.abs(a-s.end)<1e-6) return i;} return -1; }
function spin(){ if(spinning||seg.length===0) return; spinning=true; const i=pick(), tgt=target(i), st=angle, dur=3600+Math.random()*1400, t0=performance.now();
 (function anim(now){ const t=Math.min((now-t0)/dur,1), ease=1-Math.pow(1-t,3); angle=st+(tgt-st)*ease; draw(); if(t<1) requestAnimationFrame(anim); else { angle=tgt; draw();
   const idx=(getIndexAtPointer()>=0)?getIndexAtPointer():i; const pickLbl=seg[idx].label; const R=document.getElementById('R'); R.style.display='inline-block'; R.textContent='🎉 '+pickLbl;
   if(!allow){ const k=items.findIndex(o=>o.label===pickLbl); if(k>=0) items.splice(k,1); rebuild(); } spinning=false; } })(t0); }
document.getElementById('start').onclick=spin; document.getElementById('reset').onclick=()=>{ angle=0; draw(); document.getElementById('R').style.display='none'; };
rebuild();
<\/script></body></html>`;
}

/* Init */
rebuildSegments(); drawWheel();
</script>
</body>
</html>
